{% extends "base.html" %}

{% block title %}RESULT // VIDEO SUMMARIZE{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    {% if job.metadata %}
    <div class="border-2 border-zinc-800 bg-zinc-950 p-4 mb-6">
        <div class="flex gap-4 items-center">
            <img src="{{ job.metadata.thumbnail }}" alt="" class="w-28 h-auto border-2 border-zinc-700 flex-shrink-0">
            <div class="flex-1 min-w-0">
                <h2 class="font-extrabold text-white text-sm uppercase leading-snug">{{ job.metadata.title }}</h2>
                <p class="text-zinc-600 text-xs mt-1 uppercase tracking-wider">{{ job.metadata.channel }} // {{ job.metadata.duration_str }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    {% if job.status.value == "failed" %}
    <div class="brutal-box-hot bg-black p-6 mb-6">
        <h2 class="text-xl font-extrabold text-hot uppercase mb-2">!! FAILED</h2>
        <p class="text-zinc-400 text-sm">{{ job.error }}</p>
        <a href="/" class="inline-block mt-4 text-hot font-bold text-sm uppercase hover:underline">&larr; TRY AGAIN</a>
    </div>
    {% else %}

    <!-- Stats -->
    <div class="flex flex-wrap gap-2 mb-6">
        {% if job.total_time > 0 %}
        <span class="bg-lime-400 text-black text-xs font-extrabold px-3 py-1.5 uppercase">
            Total {{ "%.1f" | format(job.total_time) }}s
        </span>
        {% endif %}
        {% if job.download_time > 0 %}
        <span class="bg-zinc-900 border-2 border-zinc-700 text-zinc-400 text-xs font-bold px-3 py-1.5 uppercase">
            DL {{ "%.1f" | format(job.download_time) }}s
        </span>
        {% endif %}
        {% if job.transcribe_time > 0 %}
        <span class="bg-zinc-900 border-2 border-zinc-700 text-zinc-400 text-xs font-bold px-3 py-1.5 uppercase">
            STT {{ "%.1f" | format(job.transcribe_time) }}s
        </span>
        {% endif %}
        {% if job.summarize_time > 0 %}
        <span class="bg-zinc-900 border-2 border-zinc-700 text-zinc-400 text-xs font-bold px-3 py-1.5 uppercase">
            LLM {{ "%.1f" | format(job.summarize_time) }}s
        </span>
        {% endif %}
        {% if job.word_count > 0 %}
        <span class="bg-zinc-900 border-2 border-zinc-700 text-electric text-xs font-bold px-3 py-1.5 uppercase">
            {{ "{:,}".format(job.word_count) }} words
        </span>
        {% endif %}
        {% if job.whisper_model %}
        <span class="bg-zinc-900 border-2 border-zinc-700 text-yolk text-xs font-bold px-3 py-1.5 uppercase">
            whisper:{{ job.whisper_model }}
        </span>
        {% endif %}
        {% if job.summarizer_model %}
        <span class="bg-zinc-900 border-2 border-zinc-700 text-hot text-xs font-bold px-3 py-1.5 uppercase">
            {{ job.summarizer_model }}
        </span>
        {% endif %}
        {% if job.created_by %}
        <span class="bg-zinc-900 border-2 border-zinc-700 text-electric text-xs font-bold px-3 py-1.5 uppercase">
            by {{ job.created_by }}
        </span>
        {% endif %}
    </div>

    <!-- Summary -->
    <div class="brutal-box-lime bg-black p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-extrabold uppercase text-lime-400">// SUMMARY</h2>
            <button onclick="copyToClipboard('summary-content', this)" class="brutal-btn bg-lime-400 text-black text-xs font-extrabold px-3 py-1.5 uppercase flex items-center gap-1.5">
                <span>COPY</span>
            </button>
        </div>
        <div class="prose text-zinc-300 leading-relaxed text-sm" id="summary-content"></div>
        <script>
            document.getElementById('summary-content').innerHTML =
                marked.parse({{ job.summary | tojson }});
        </script>
    </div>

    <!-- Transcript -->
    <div class="border-2 border-zinc-700 bg-black">
        <button
            onclick="toggleTranscript()"
            class="w-full p-4 flex justify-between items-center text-left hover:bg-zinc-950 transition-colors"
        >
            <h2 class="text-lg font-extrabold uppercase text-zinc-500">// TRANSCRIPT</h2>
            <span id="transcript-chevron" class="text-zinc-600 text-xl font-bold transition-transform">&darr;</span>
        </button>
        <div id="transcript-body" class="hidden px-6 pb-6">
            <div class="flex items-center justify-between mb-4 border-b-2 border-zinc-800 pb-3">
                <p class="text-zinc-600 text-xs uppercase tracking-wider">
                    {% if job.transcript_language %}lang:{{ job.transcript_language }} // {% endif %}{{ "{:,}".format(job.word_count) }} words
                </p>
                <button onclick="copyToClipboard('transcript-text', this)" class="brutal-btn bg-zinc-800 text-zinc-400 text-xs font-extrabold px-3 py-1.5 uppercase flex items-center gap-1.5 hover:text-white">
                    <span>COPY</span>
                </button>
            </div>
            <div id="transcript-text" class="space-y-1.5">
                {% for seg in job.transcript_segments %}
                <div class="flex gap-3 hover:bg-zinc-950 py-0.5">
                    <span class="text-electric text-xs font-bold whitespace-nowrap pt-0.5 w-14">{{ seg.start_str }}</span>
                    <p class="text-zinc-400 text-xs leading-relaxed">{{ seg.text }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    {% endif %}

    <div class="mt-8 text-center">
        <a href="/" class="text-zinc-600 hover:text-lime-400 font-bold text-sm uppercase tracking-wider transition-colors">&larr; BACK</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleTranscript() {
    const body = document.getElementById('transcript-body');
    const chevron = document.getElementById('transcript-chevron');
    const open = body.classList.toggle('hidden');
    chevron.innerHTML = open ? '&darr;' : '&uarr;';
}

function copyToClipboard(elementId, btn) {
    const el = document.getElementById(elementId);
    const text = el.innerText || el.textContent;
    navigator.clipboard.writeText(text).then(() => {
        const span = btn.querySelector('span');
        const original = span.textContent;
        span.textContent = 'COPIED!';
        btn.classList.add('bg-electric', 'text-black');
        setTimeout(() => {
            span.textContent = original;
            btn.classList.remove('bg-electric', 'text-black');
        }, 1500);
    });
}
</script>
{% endblock %}
